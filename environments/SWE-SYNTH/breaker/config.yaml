# Breaker Module Configuration
# Prompt templates for Bug Injector and Problem Summarizer agents

injector:
  # Bug Injector Agent - injects bugs into correct code
  system_template: |
    You are a code mutation expert. Your task is to inject realistic bugs into correct code.
    Your response must contain exactly ONE bash code block with ONE command (or commands connected with && or ||).

    Include a THOUGHT section before your command where you explain your reasoning process.
    Format your response as shown in <format_example>.

    <format_example>
    THOUGHT: Your reasoning and analysis here

    ```bash
    your_command_here
    ```
    </format_example>

    Failure to follow these rules will cause your response to be rejected.

  instance_template: |
    <task>
    You are a BUG INJECTION agent. Your goal is to introduce a realistic bug that causes tests to FAIL.

    Repository: {{repo}}
    Bug types to inject: {{bug_types_str}}
    </task>

    <bug_type_descriptions>
    {{bug_descriptions}}
    </bug_type_descriptions>

    <gold_patch>
    This patch was recently applied to fix a bug. The code is now CORRECT and all tests pass.
    Your job is to re-introduce a bug (different from the original) that breaks the tests.

    ```diff
    {{gold_patch}}
    ```
    </gold_patch>

    <target_tests>
    These tests currently PASS. Your bug should cause at least one to FAIL:
    {{target_tests_str}}
    </target_tests>

    {% if test_patch_snippet %}
    <test_code>
    Analyze these test assertions to understand what values/behaviors they expect:
    ```
    {{test_patch_snippet}}
    ```
    </test_code>
    {% endif %}

    {% if feedback %}
    <previous_attempt_feedback>
    Your previous attempt failed. Here's the feedback:
    {{feedback}}

    Please try a DIFFERENT approach this time.
    </previous_attempt_feedback>
    {% endif %}

    <instructions>
    ## Your Workflow

    1. **Explore**: Read the source files modified by gold_patch to understand the code
    2. **Analyze**: Study the test code to understand what behaviors are being tested
    3. **Plan**: Identify a good location to inject a bug that will cause test failures
    4. **Inject**: Create a patch that introduces a subtle, realistic bug
    5. **Verify**: Apply your patch and run tests to confirm at least one test fails
    6. **Iterate**: If no tests fail, analyze why and try a different approach

    ## Bug Injection Rules

    - Make SUBTLE changes (what a tired developer might write)
    - NO syntax errors - code must still run
    - Focus on return values, conditionals, error handling - these affect test outcomes
    - Avoid cosmetic changes (comments, whitespace) - they don't break tests
    - Your bug should cause 1-10 tests to fail, not catastrophic failure

    ## Environment Setup (ALREADY DONE)

    The environment is already set up:
    - Working directory: /app (repository root)
    - Gold patch ALREADY APPLIED - code is correct, all tests pass
    - DO NOT apply gold_patch yourself - it's already done!

    ## Files in /workspace

    - `/workspace/gold_patch.diff` - The gold patch (already applied, for reference only)
    - `/workspace/run_tests.sh` - Run this to execute tests
    - `/workspace/run_script.sh` - Test runner script
    - `/workspace/parser.py` - Test output parser

    ## Commands You Should Use

    1. Read source files: `cat src/path/to/file.js` or `head -n 100 <file>`
    2. Search code: `grep -n "pattern" src/`
    3. Run tests: `bash /workspace/run_tests.sh`
    4. Edit files with sed: `sed -i 's/old/new/g' file.py`
    5. Check your changes: `git diff`

    ## Submission

    When you have successfully injected a bug that causes tests to fail:

    1. First, save your bug patch to a file (only source code changes):
    ```bash
    git diff -- '*.js' '*.ts' '*.py' '*.java' '*.go' '*.c' '*.cpp' '*.h' '*.rs' '*.rb' '*.php' > /workspace/final_bug.patch && cat /workspace/final_bug.patch
    ```

    2. Then submit with your description:
    ```bash
    echo COMPLETE_TASK_AND_SUBMIT_FINAL_OUTPUT && cat <<'RESULT'
    BUG_DESCRIPTION:
    <technical description of what bug you injected and why it causes test failures>
    RESULT
    ```

    IMPORTANT: The bug patch will be read from git diff. Make sure your changes are applied before submitting!
    </instructions>

  action_observation_template: |
    <returncode>{{output.returncode}}</returncode>
    {% if output.output | length < 10000 -%}
    <output>
    {{ output.output -}}
    </output>
    {%- else -%}
    <warning>
    The output of your last command was too long.
    Please try a different command that produces less output.
    </warning>
    {%- set elided_chars = output.output | length - 10000 -%}
    <output_head>
    {{ output.output[:5000] }}
    </output_head>
    <elided_chars>
    {{ elided_chars }} characters elided
    </elided_chars>
    <output_tail>
    {{ output.output[-5000:] }}
    </output_tail>
    {%- endif -%}

  format_error_template: |
    Please always provide EXACTLY ONE action in triple backticks, found {{actions|length}} actions.

    Format your response as:
    THOUGHT: Your reasoning

    ```bash
    your_command_here
    ```

  # Default limits
  step_limit: 50
  cost_limit: 10.0
  temperature: 0.7


summarizer:
  # Problem Summarizer - generates user-facing problem statement from bug
  prompt_template: |
    You are a software engineer writing a bug report. Based on the following information,
    write a clear problem statement that describes the bug from a user/developer perspective.

    ## Repository
    {{repo}}

    ## Bug Type
    The bug is a **{{bug_types_str}}** type bug.
    {{bug_type_descriptions}}

    ## The Bug (Code Changes)
    Analyze this diff carefully - it shows EXACTLY what code was changed to introduce the bug:
    ```diff
    {{bug_patch}}
    ```

    ## Failed Tests
    These tests now fail after the bug was introduced:
    {{failed_tests_str}}

    ## Test Error Output
    Look at the ACTUAL error messages and values - these reveal the symptoms:
    ```
    {{error_output}}
    ```

    {% if test_patch %}
    ## Related Test Code
    ```
    {{test_patch}}
    ```
    {% endif %}

    ## Requirements

    Write a problem statement that:
    1. Describes the OBSERVABLE SYMPTOM based on test error output (e.g., wrong value, malformed string, incorrect message)
    2. Identifies what feature/functionality is affected
    3. Explains when/how the issue manifests

    CRITICAL RULES:
    - Base your description on the ACTUAL code change in the diff
    - If it's a string-format bug, describe the string/message issue (e.g., "displays 'undefined'", "shows wrong format")
    - If it's an off-by-one bug, describe the numeric issue (e.g., "returns 9 instead of 10", "off by one")
    - If it's a logic-inversion bug, describe the inverted behavior (e.g., "returns true when it should return false")
    - Use SPECIFIC values from the test error output when available
    - Do NOT mention line numbers, variable names, or the fix
    - Do NOT mention that this is an artificially injected bug
    - Write 2-4 sentences maximum

    Examples by bug type:

    For string-format bug:
    "The email rate-limit error message displays 'undefined' instead of the configured wait time. When users try to resend confirmation emails too quickly, they see 'Please wait undefined minutes' instead of the actual interval."

    For off-by-one bug:
    "The pagination returns one fewer item than requested. When requesting 10 items per page, only 9 are returned, causing the last item to be missing from each page."

    For logic-inversion bug:
    "The permission check incorrectly denies access to authorized users. Users with valid admin privileges are being rejected when trying to access the admin panel."

    For wrong-variable bug:
    "The user profile displays the email field in the username location. When viewing a profile, the username shows the user's email address instead of their actual username."

    Output ONLY the problem statement, no other text:
